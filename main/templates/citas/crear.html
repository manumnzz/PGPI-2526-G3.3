{% extends "base.html" %}
{% load static %}
{% block content %}

<!-- =========================== -->
<!--     Flatpickr (Calendar)    -->
<!-- =========================== -->

<link rel="stylesheet" 
href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>

<style>

.crear-wrapper {
    max-width: 1000px;
    margin: 40px auto;
    background: white;
    padding: 35px;
    border-radius: 20px;
    border: 2px solid #00a7a7;
    box-shadow: 0px 6px 20px rgba(0,0,0,0.15);
}

.crear-grid {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 40px;
}

/* Calendario box */
.calendar-box {
    padding: 20px;
    border-radius: 15px;
    border: 2px solid #00a7a7;
}

.calendar-title {
    text-align: center;
    font-size: 26px;
    font-weight: bold;
    color: #007f7f;
    margin-bottom: 10px;
}

/* Flatpickr custom style */
.flatpickr-calendar.inline {
    width: 100% !important;
    box-shadow: none !important;
    border: none !important;
}

.flatpickr-day.selected,
.flatpickr-day.startRange,
.flatpickr-day.endRange {
    background: #00b5c3 !important;
    border-color: #00b5c3 !important;
}

.flatpickr-day.today {
    border-color: #00b5c3 !important;
}

/* Selector */
.selector {
    width: 100%;
    padding: 12px;
    border-radius: 10px;
    border: 2px solid #00a7a7;
    margin-top: 10px;
}

/* Horas */
.hour-box {
    border-radius: 15px;
    border: 2px solid #00a7a7;
    padding: 20px;
}

.hour-btn {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    background: #e6ffff;
    color: #006060;
    margin-bottom: 12px;
    border: 2px solid #009999;
    font-weight: bold;
    cursor: pointer;
    transition: 0.15s;
}

.hour-btn:hover {
    background: #00c8c8;
    color: white;
}

.hour-selected {
    background: #00c8c8 !important;
    color: white !important;
    border-color: #00a7a7 !important;
}

/* Botón reservar */
.btn-reservar {
    background: #00b5c3;
    border: none;
    border-radius: 20px;
    padding: 14px;
    color: white;
    width: 100%;
    font-size: 20px;
    font-weight: bold;
    margin-top: 15px;
}

.btn-reservar:hover {
    background: #0092a0;
}

</style>

<div class="crear-wrapper">

    <h2 class="text-center mb-4">Reservar Cita</h2>

    <form method="POST">
        {% csrf_token %}

        <div class="crear-grid">

            <!-- IZQUIERDA - Calendario + Selectores -->
            <div>

                <div class="calendar-box mb-4">
                    <h3 class="calendar-title">Selecciona una fecha</h3>

                    <!-- CALENDARIO INLINE -->
                    <div id="calendarInline"></div>

                    <!-- Fecha seleccionada para Django -->
                    <input type="hidden" name="fecha" id="fechaSeleccionada">
                </div>

                <label><strong>Servicio:</strong></label>
                <select name="service_id" class="selector" id="serviceSelector">
                    {% for s in services %}
                    <option value="{{ s.id }}" {% if s.id == service.id %}selected{% endif %}>
                        {{ s.title }}
                    </option>
                    {% endfor %}
                </select>

                <label class="mt-3"><strong>Tarifa:</strong></label>
                <select name="tarifa_id" class="selector" id="tarifaSelector">
                    {% for t in tarifas %}
                    <option value="{{ t.id }}" {% if t.id == tarifa.id %}selected{% endif %}>
                        {{ t.title }} — €{{ t.price }}
                    </option>
                    {% endfor %}
                </select>

            </div>

            <!-- DERECHA - Selección de horas -->
            <div class="hour-box">
                <p class="fw-bold text-center">Seleccione hora:</p>

                <input type="hidden" name="hora" id="horaFinal">

                <div id="hourButtons">
                    {% for h in hours %}
                        <button type="button" class="hour-btn" data-hour="{{ h }}">{{ h }}</button>
                    {% endfor %}
                </div>

                <button class="btn-reservar mt-3">RESERVAR</button>
            </div>

        </div>

        <p class="text-center mt-3">
            <small>Confirma tu cita. Si tuvieras algún problema, comunícalo con 24h de antelación.</small>
        </p>

    </form>

</div>

<!-- =========================== -->
<!-- JAVASCRIPT -->
<!-- =========================== -->

<script>
// Inicializar calendario inline
flatpickr("#calendarInline", {
    inline: true,
    locale: "es",
    dateFormat: "Y-m-d",
    minDate: "today",
    onChange: function(selectedDates, dateStr) {
        document.getElementById("fechaSeleccionada").value = dateStr;
    }
});

// Selección de horas
document.querySelectorAll(".hour-btn").forEach(btn => {
    btn.addEventListener("click", function() {

        document.querySelectorAll(".hour-btn").forEach(b => b.classList.remove("hour-selected"));

        this.classList.add("hour-selected");

        document.getElementById("horaFinal").value = this.dataset.hour;
    });
});
</script>

{% endblock %}
